<!DOCTYPE html>
<html   xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


    <!-- Bootstrap Core CSS -->
    <link href="/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="/vendor/metisMenu/metisMenu.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="/dist/css/sb-admin-2.css" rel="stylesheet">

    <!-- Morris Charts CSS -->
    <link href="/vendor/morrisjs/morris.css" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="/vendor/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">





</head>
<body>
<h2>등록</h2>

  bno :  <input type="text" th:value="${dto.bno}" readonly> <br>

  title : <input type="text" th:value="${dto.title}" readonly> <br>
  content : <input type="text" th:value="${dto.content}" readonly> <br>
  writer : <input type="text" th:value="${dto.writer}" readonly> <br>

  등록일: <input type="text" th:value="${#temporals.format(dto.regDate, 'yyyy-MM-dd')}" readonly>

  수정일: <input type="text" th:value="${#temporals.format(dto.modDate, 'yyyy-MM-dd HH:mm:ss')}" readonly>


  <div th:with="link = ${pageRequestDTO.getLink()}">
        <a th:href="|@{/board/list}?${link}|">
            <button type="button">Listaa</button>
        </a>
        <a th:href="|@{/board/modify(bno=${dto.bno})}&${link}|">
            <button type="button">Modify</button>
        </a>
  </div>
[[${dto.bno}]] [[${pageRequestDTO.page}]]
등록<br>
내용 : <input type="text" name="replyText" id="replyText"><br>
작성자 : <input type="text" name="replyer" id="replyer">
<button id="rBtn">댓글등록</button>
<button id="lis">목록</button>
<button type="button" class="aaa">버튼</button>

<div class="chat-panel panel panel-default">
    <div class="panel-heading">
        <i class="fa fa-comments fa-fw"></i> Chat
        <div class="btn-group pull-right">
            <button type="button" class="btn btn-outline pull-right btn-primary btn-xs" id="addReplyBtn" data-toggle="modal" data-target="#myModal">Mini button</button>

        </div>
    </div>
    <!-- /.panel-heading -->
    <div class="panel-body">
        <ul class="chat">
            <li class="right clearfix">

                <div class="chat-body clearfix" style=" margin-right: 77px;">
                    <div class="header">
                        <strong class="primary-font">Jack Sparrow</strong>
                        <small class="pull-right text-muted">
                            <i class="fa fa-clock-o fa-fw"></i> 12 mins ago
                        </small>
                    </div>
                    <p>
                        Lorem ipsum dolor sit amet, consectetur adipiscing elit. Curabitur bibendum ornare dolor, quis ullamcorper ligula sodales.
                    </p>
                </div>
            </li>







        </ul>
    </div>
    <!-- /.panel-body -->
    <div class="panel-footer">
        <div class="input-group">
            <input id="btn-input" type="text" class="form-control input-sm" placeholder="Type your message here...">
            <span class="input-group-btn">
                                    <button class="btn btn-warning btn-sm" id="btn-chat">
                                        Send
                                    </button>
                                </span>
        </div>
    </div>
    <!-- /.panel-footer -->
</div>

<div class="col-lg-6">
    <div class="panel panel-default1">

        <!-- /.panel-heading -->
        <div class="panel-body1">
            <!-- Modal -->
            <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true" style="display: none;">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                            <h4 class="modal-title" id="myModalLabel">Reply Modal</h4>
                        </div>
                        <div class="modal-body">

                            <div class="form-group">
                                <label>댓글내용</label>
                                <input class="form-control" name="replyText">
                                <p class="help-block">바른말 고운말을 사용합시다</p>
                            </div>

                            <div class="form-group">
                                <label>Text Input</label>
                                <input class="form-control" name="replyer">
                                <p class="help-block">작성자</p>
                            </div>


                       </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary">Save changes</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>
            <!-- /.modal -->
        </div>
        <!-- .panel-body -->
    </div>
    <!-- /.panel -->
</div>

<script type="text/javascript" src="/js/reply.js"></script>

<script th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function (){
        console.log(replyService);


        const bno = [[${dto.bno}]];
        const rBtn = document.querySelector("#rBtn");
        let pageRequestDTO = [[${pageRequestDTO}]];
        // pageRequestDTO.page =
        let replyUL = document.querySelector(".chat");
        console.log(replyUL);
        showList(1);

        function showList(page){

            console.log("show list " + page);

            replyService.getList({bno:bno, page : page || 1}, function (pageResponseDTO){
                console.log("pageResponseDTO : " + pageResponseDTO.dtoList[0].rno);
                console.log("pageResponseDTO : " + pageResponseDTO.page);
                console.log("pageResponseDTO : " + pageResponseDTO.total);


                if(pageResponseDTO.page == -1) {
                    pageNum = Math.ceil(pageResponseDTO.total/10.0);
                    showList(pageNum);
                    return;
                }
                let dtoList = pageResponseDTO.dtoList;
                let str = "";

                if(dtoList ==  null || dtoList.length == 0){
                    return;
                }



                for (let i = 0, len = dtoList.length || 0; i < len; i++){
                    str +=  '<li class="right clearfix"><div class="chat-body clearfix" style=" margin-right: 10px;" data-rno="'+dtoList[i].rno +'"><div class="header"><strong class="primary-font">' +dtoList[i].replyer;
                    str +=  '</strong><small class="pull-right text-muted"><i class="fa fa-clock-o fa-fw"></i>'+ replyService.displayTime(dtoList[i].regDate) ;
                    str +='</small></div><p>' +dtoList[i].replyText;
                    str += '</p></div></li>';
                }
                console.log(str);
                replyUL.innerHTML = str;
                //replyUL.html(str);
            }); //end function

        }// endshowList
        //등록버튼 클릭시
        let modal = $(".modal");
        let modalInputReplyText = modal.find("input[name='replyText']");
        let modalInputReplyer = modal.find("input[name='replyer']");

        let modalModBtn = $("#modalModBtn");
        let modalRemoveBtn = $("#modalRemoveBtn");
        let modalRegisterBtn = $("#modalRegisterBtn");

        $("#addReplyBtn").on("click", function (e){
            console.log("모달창");
            modal.find("input").val("");
            modal.find("button[id != 'modalCloseBtn']").hide(); //있다면

            modalRegisterBtn.show();        //숨어 있다면

            $(".modal").modal("show");      //처리가 필요해보임
        });

        //저장버튼 클릭시
        modalRegisterBtn.on("click", function (e){
            let reply = {
                replyText : modalInputReplyText.val(),
                replyer : modalInputReplyer.val(),
                bno:bno
            };

            replyService.add(reply, function (result){
               alert(result);
            });

            modal.find("input").val("");
            modal.modal("hide");        // 처리필요


            //저장이후  갱신필요
            showList(1);
            //showList(-1);  마지막 페이지?

        });

        //글목록 클릭시
        $(".chat").on("click", "li", function(e){
            let rno = $(this).data("rno");
            console.log("rno");
            
            replyService.get(rno, function (reply) {
               modalInputReplyText.val(reply.replyText);
               modalInputReplyer.val(reply.replyer);
               modal.data("rno", reply.rno);

               //버튼 미삭제시
               modal.find("button[id != 'modalCloseBtn']").hide();
               modalModBtn.show();
               modalRemoveBtn.show();

               $(".modal").modal("show");
            });
        });

        //수정
        modalModBtn.on("click", function (e){
            let reply = {
                rno:modal.data("rno"),
                replyText: modalInputReplyText.val()
            };

            replyService.update(reply, function (result){
                alert(reply);
                modal.modal("hide");
                //갱신
                showList(1);
                //showList(pageNum);


            });


        });

        modalRemoveBtn.on("click", function (e){
            let rno = modal.data("rno");

            replyService.remove(rno, function (result){
                alert(reply);
                modal.modal("hide");
                //갱신
                showList(1);
                //showList(pageNum);
            });


        });

        let pageNum = 1;
        let replyPageFooter = $(".panel-footer");

        function showReplyPage(replyCnt){
            let endNum = Math.ceil(pageNum / 10.0) * 10;
            let startNum = endNum -9;

            let prev = startNum != 1;
            let next = false;

            if(endNum * 10 >= replyCnt){
                endNum = Math.ceil(replyCnt /10.0);
            }

            if(endNum * 10 < replyCnt){
                next = true;
            }

            let  str = "<ul class='pagination pull-right'>";

            if(prev){
                str += "<li class='page-item'><a class='page-link' href='" +(startNum -1)+ "'>이전</a></li>";
            }

            for(let i = startNum; i<= endNum; i++){
                let active = pageNum == i? "active" : "";
                str += "<li class='page-item " +active+ "'><a class='page-link' href='" +i+ "'>" + i + "</a></li>";
            }

            if(next){
                str += "<li class='page-item'><a class='page-link' href='" +(endNum +1)+ "'>다음</a></li>";
            }

            str += "</ul></div>";

            console(str);

            replyPageFooter.html(str)

            showReplyPage(replyCnt);
        };


        replyPageFooter.on("click", "li a", function (e) {
           e.preventDefault();
           console.log("page click");

           let targetPageNum = $(this).attr("href");

           console.log("targetPageNum : " + targetPageNum);

           pageNum = targetPageNum;

           showList(pageNum);
        });


    });















/*    document.getElementById('lis').addEventListener("click",function (e){
        let aqq = {bno:bno, page:1};
        getList(aqq);
    });*/

/*
    rBtn.addEventListener("click", function (e) {
        const reply = {
            replyText: document.getElementById('replyText').value,
            replyer : document.getElementById('replyer').value,
            bno : bno,

        };
        console.log(reply);
        $.ajax({
            type : 'post',
            url : '/replies/',
            data: JSON.stringify(reply),
            contentType: "application/json; charset=utf-8",
            success : function (result, status, xhr) {
                console.log(result);
            },
            error : function (xhr, status, er){
                console.log(er);
            }

        });
    });
*/

/*
    function getList(param, callback, error){

        let bno = param.bno;
         let page = param.page || 1 ;

        let pageRequestDTO = {
            page : param.page || 1
        };

        // GET 방식으로 서버에 HTTP Request를 보냄.
        $.get("/replies/lista/" + bno, pageRequestDTO,
            function(data, status) {
                $("#text").html(data + "<br>" + status); // 전송받은 데이터와 전송 성공 여부를 보여줌.
                console.log(data);
                console.log(data.dtoList[0]);
                console.log(data.dtoList.length);
                for (let i=0; i<data.dtoList.length; i++){
                    console.log(data.dtoList[i].rno +"  "+data.dtoList[i].replyText+"  "+data.dtoList[i].replyer);
                    console.log(status);

                }
            }
        );


/!*    $.ajax({
            type : 'get',
            url : "/replies/list/"+bno,
            data: pageRequestDTO,
            contentType: "application/json; charset=utf-8",
            success : function (result, status, xhr) {
                console.log(result);
                console.log(result.dtoList[0]);
                console.log(result.dtoList.length);
                for (let i=0; i<result.dtoList.length; i++){
                    console.log(result.dtoList[i].rno +"  "+result.dtoList[i].replyText+"  "+result.dtoList[i].replyer);
                    console.log();
                    console.log();
                }
            },
            error : function (xhr, status, er){
                console.log(er);
            }

        });*!/

    };
*/



</script>



<!--<script th:inline="javascript">

    const page = "1";
    document.querySelector(".aaa").addEventListener("click",function (e) {
        $.get({
            url: '/replies/lista/'+bno,
            method: 'get',
            contentType:"application/json",
            success: function (data, status, xhr) {

                    console.log(data);

            },
            error: function (data, status, err) {
            }
        });
    });


</script>-->
<script src="/vendor/jquery/jquery.min.js"></script>


<!-- Bootstrap Core JavaScript -->
<script src="/vendor/bootstrap/js/bootstrap.min.js"></script>

<!-- Metis Menu Plugin JavaScript -->
<script src="/vendor/metisMenu/metisMenu.min.js"></script>

<!-- Morris Charts JavaScript -->
<script src="/vendor/raphael/raphael.min.js"></script>
<script src="/vendor/morrisjs/morris.min.js"></script>


<!-- Custom Theme JavaScript -->
<script src="/dist/js/sb-admin-2.js"></script>
</body>
</html>